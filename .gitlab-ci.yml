image: xwiillz/node-yarn-firefox-chromium:latest
cache:
    key: "$CI_COMMIT_REF_NAME"
    paths:
        - client/node_modules/
        - server/node_modules/
    policy: pull
stages:
    - install
    - lint
    - build
    - test
install:
    stage: install
    script:
        - pushd client
        - yarn
        - popd
        - pushd server
        - yarn
        - popd
    cache:
        key: "$CI_COMMIT_REF_NAME"
        paths:
            - client/node_modules/
            - server/node_modules/
        policy: pull-push
lint:client:
    stage: lint
    script:
        - pushd client
        - yarn lint
        - popd
# lint:server:
#     stage: lint
#     script:
#         - pushd server
#         - yarn lint
#         - popd
build:client:
    stage: build
    script:
        - pushd client
        - yarn build
        - popd
    artifacts:
        paths:
            - client/dist/
# build:server:
#     stage: build
#     script:
#         - pushd server
#         - yarn tsc
#         - popd
#     artifacts:
#         paths:
#             - server/out/
test:client:
    stage: test
    script:
        - Xvfb :99 -ac -screen 0 1920x1080x24 &
        - pushd client
        - yarn coverage --browsers ChromeHeadlessNoSandbox
        - popd
    dependencies:
        - build:client
    artifacts:
        paths:
            - client/coverage/
# test:server:
#     stage: test
#     script:
#         - pushd server
#         - yarn coverage
#         - popd
#     dependencies:
#         - build:server
#     artifacts:
#         paths:
#             - server/coverage/
